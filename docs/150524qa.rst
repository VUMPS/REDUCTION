=============================
Reduction Code Quality Checks
=============================

This document describes the analysis and quality checks
of the VUMPS reduction code. Data used for the analysis
were taken on 150523 and 150524, which were the last two
days of the initial commissioning period at Yale.

Additional flats
================

High SNR flats were not taken on 150524, but *were* taken on 150523. Many changes were made to the spectrometer during commissioning, and one cannot be certain that spectra taken on the 23rd will line up with spectra taken on the 24th.

The routine ```compare_flats.pro`` restores and projects in the cross-dispersion direction three separate exposures: a flat taken on the 23rd, a flat taken on the 24th, and a solar spectrum taken with the lens on the fiber head that was taken on the 24th. Below is the result:

.. image:: figures/compare_flats.png
  :width: 90%

This shows that orders in the flats from the 23rd and 24th, and solar spectra from the 24th all line up well. Now that consistent order positions have been established, flats taken on the 23rd can be copied to the data directory for the 24th and renamed to be used for reducing data taken on 150524:

::

    cp /raw/vumps/150523/vumps150523.103[2-9]*
    cp /raw/vumps/150523/vumps150523.10[4-6]*
    rename -v 's/vumps150523.10(\d+).fit/vumps150524.11$1.fit/' vumps150523.1*

Lastly, the 150523 flats copied and renamed in the 150524 directory were added to the logsheet before reducing the 150524 data.

Extracting the Blue
===================

The tungsten-halogen lamp used for flat-fielding emits very little light in the blue. The lack of counts in this regime makes tracing the orders difficult.

.. image:: https://www.thorlabs.com/images/TabImages/QTH10_Spectrum_400.gif
  :width: 90%

Attempts to filter the quartz light were made with several filters; to date the KB15 filter provided the best results. Nonetheless, there are still too few counts in the blue for optimal order tracing.

This was solved by combining two sets of exposures taken with different exposure times: shorter exposures were taken to get a high, yet unsaturated counts in the red, and longer exposures were taken to get high counts in the blue at the compromise of saturation in the red. These were then combined by exponentially attenuating the counts in the red for the saturated exposures in software. This optional feature of the reduction code can be turned off and on through the `blues` key in the vumps.par file.
The resulting combined image is shown in the figure below.


It goes to 11
=============

Depending on the level of quality assurance and user interaction desired, the VUMPS reduction code has a number of "debug" levels:

0. Production mode: no figures are created and there are no stops
1. Semi-production mode: there are no stops, but several plots are saved to disk.
2. Several stops and plots are displayed on screen
3. More stops, more plots
4. More stops and prompts to optionally manually define the echelle order peaks.

10. More stops to check the identified peaks in every cross-dispersion swath
11. Even more stops and plots.

Like all options, this is set in the vumps.par file.
